<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>检测记录 - 智能图像分析系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .records-container {
            margin-top: 2rem;
        }
        
        .record-card {
            background-color: var(--card-bg-light);
            border-radius: 12px;
            padding: 1.8rem;
            margin-bottom: 1.8rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            border-left: 4px solid #ddd;
        }
        
        .dark-theme .record-card {
            background-color: var(--card-bg-dark);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            border-left: 4px solid #444;
        }
        
        .record-card[data-type="image"] {
            border-left-color: #4dabf7;
        }
        
        .record-card[data-type="video"] {
            border-left-color: #f783ac;
        }
        
        .record-card[data-type="camera"] {
            border-left-color: #63e6be;
        }
        
        .dark-theme .record-card[data-type="image"] {
            border-left-color: #339af0;
        }
        
        .dark-theme .record-card[data-type="video"] {
            border-left-color: #e64980;
        }
        
        .dark-theme .record-card[data-type="camera"] {
            border-left-color: #38d9a9;
        }
        
        .record-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .dark-theme .record-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.5rem;
        }
        
        .dark-theme .record-header {
            border-bottom: 1px solid var(--border-dark);
        }
        
        .record-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        
        .record-date {
            font-size: 0.9rem;
            color: var(--text-secondary-light);
        }
        
        .dark-theme .record-date {
            color: var(--text-secondary-dark);
        }
        
        .record-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .record-details {
                grid-template-columns: 1fr;
            }
        }
        
        .record-info {
            margin-bottom: 1rem;
        }
        
        .record-info h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary-light);
        }
        
        .dark-theme .record-info h3 {
            color: var(--text-secondary-dark);
        }
        
        .record-info p {
            margin: 0;
        }
        
        .record-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .record-image {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: #f8f9fa;
            transition: transform 0.2s;
        }
        
        .dark-theme .record-image {
            background-color: #343a40;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .record-image:hover {
            transform: scale(1.02);
        }
        
        .record-image img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: contain;
            max-height: 300px;
        }
        
        .record-image h4 {
            font-size: 1rem;
            text-align: center;
            margin: 0;
            padding: 0.8rem;
            background-color: rgba(0, 0, 0, 0.03);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .dark-theme .record-image h4 {
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-processing {
            background-color: #f0ad4e;
            color: #fff;
        }
        
        .status-completed {
            background-color: #5cb85c;
            color: #fff;
        }
        
        .status-error {
            background-color: #d9534f;
            color: #fff;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        .pagination a, .pagination span {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 4px;
            text-decoration: none;
            color: var(--text-primary-light);
            background-color: var(--card-bg-light);
            transition: background-color 0.2s;
        }
        
        .dark-theme .pagination a, .dark-theme .pagination span {
            color: var(--text-primary-dark);
            background-color: var(--card-bg-dark);
        }
        
        .pagination a:hover {
            background-color: var(--primary-light);
            color: #fff;
        }
        
        .pagination .current {
            background-color: var(--primary-light);
            color: #fff;
        }
        
        .dark-theme .pagination .current {
            background-color: var(--primary-dark);
        }
        
        .empty-records {
            text-align: center;
            padding: 3rem;
            background-color: var(--card-bg-light);
            border-radius: 8px;
            margin-top: 2rem;
        }
        
        .dark-theme .empty-records {
            background-color: var(--card-bg-dark);
        }
        
        .empty-records i {
            font-size: 3rem;
            color: var(--text-secondary-light);
            margin-bottom: 1rem;
        }
        
        .dark-theme .empty-records i {
            color: var(--text-secondary-dark);
        }
        
        .view-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: var(--primary-light);
            color: white;
            border-radius: 4px;
            text-decoration: none;
            transition: background-color 0.2s;
            margin-top: 1rem;
            margin-right: 0.5rem;
        }
        
        .view-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .delete-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: #d9534f;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            transition: background-color 0.2s;
            margin-top: 1rem;
        }
        
        .delete-btn:hover {
            background-color: #c9302c;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            overflow: auto;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: var(--card-bg-light);
            margin: 5% auto;
            padding: 2.5rem;
            border-radius: 16px;
            width: 85%;
            max-width: 1000px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .dark-theme .modal-content {
            background-color: var(--card-bg-dark);
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.4);
        }
        
        .modal-section-title {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        }
        
        .dark-theme .modal-section-title {
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-section-title i {
            margin-right: 0.8rem;
            color: var(--primary-light);
        }
        
        .dark-theme .modal-section-title i {
            color: var(--primary-dark);
        }
        
        .modal-detail-section {
            margin-bottom: 2.5rem;
            background-color: rgba(0, 0, 0, 0.02);
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .dark-theme .modal-detail-section {
            background-color: rgba(255, 255, 255, 0.03);
        }
        
        .close {
            position: absolute;
            top: 1.5rem;
            right: 1.8rem;
            font-size: 1.8rem;
            color: var(--text-secondary-light);
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }
        
        .close:hover {
            color: var(--text-primary-light);
        }
        
        .dark-theme .close:hover {
            color: var(--text-primary-dark);
        }
        
        .confirm-modal .modal-content {
            max-width: 500px;
            text-align: center;
        }
        
        .confirm-modal .btn-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .confirm-modal .btn-cancel {
            background-color: #6c757d;
        }
        
        .confirm-modal .btn-delete {
            background-color: #d9534f;
        }
        
        .batch-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .checkbox-container {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .select-all-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .batch-delete-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: #d9534f;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .batch-delete-btn:hover {
            background-color: #c9302c;
        }
        
        .batch-delete-btn:disabled {
            background-color: #f5a9a7;
            cursor: not-allowed;
        }
        
        .error {
            color: #d9534f;
            margin: 1rem 0;
            padding: 1rem;
            background-color: #f8d7da;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .success {
            color: #5cb85c;
            margin: 1rem 0;
            padding: 1rem;
            background-color: #d4edda;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* 返回首页链接样式 */
        .nav-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--text-primary-light);
            font-weight: 500;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .dark-theme .nav-logo {
            color: var(--text-primary-dark);
        }
        
        .nav-logo i {
            font-size: 1.2rem;
        }
        
        .nav-logo:hover {
            color: var(--primary-light);
            transform: translateX(-3px);
        }
        
        .dark-theme .nav-logo:hover {
            color: var(--primary-dark);
        }
        
        /* 添加面包屑导航 */
        .back-link {
            margin-bottom: 20px;
        }
        
        .btn-back {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background-color: var(--card-bg-light);
            color: var(--text-primary-light);
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .dark-theme .btn-back {
            background-color: var(--card-bg-dark);
            color: var(--text-primary-dark);
            border-color: rgba(255,255,255,0.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .btn-back i {
            margin-right: 8px;
        }
        
        .btn-back:hover {
            background-color: var(--primary-light);
            color: white;
            transform: translateX(-3px);
        }
        
        .dark-theme .btn-back:hover {
            background-color: var(--primary-dark);
            color: white;
        }
        
        .batch-images-container {
            margin-top: 2rem;
        }
        
        .batch-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 1rem;
        }
        
        .batch-image-item {
            border-radius: 8px;
            overflow: hidden;
            background: var(--surface-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .dark-theme .batch-image-item {
            background: var(--surface-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .batch-image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .dark-theme .batch-image-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .batch-image-container {
            position: relative;
            padding-top: 100%; /* 正方形容器 */
            overflow: hidden;
        }
        
        .batch-image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .batch-image-item:hover .batch-image-container img {
            transform: scale(1.1);
        }
        
        .batch-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            opacity: 0;
            transition: all 0.3s ease;
            padding: 10px;
        }
        
        .batch-image-item:hover .batch-image-overlay {
            opacity: 1;
        }
        
        .batch-image-status {
            background: rgba(0,0,0,0.7);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            align-self: flex-start;
        }
        
        .has-defects .batch-image-status {
            background: rgba(220,53,69,0.8);
        }
        
        .no-defects .batch-image-status {
            background: rgba(40,167,69,0.8);
        }
        
        .batch-image-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        .batch-image-actions a {
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .batch-image-actions a:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }
        
        .batch-image-name {
            padding: 8px;
            text-align: center;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 图像详情模态框样式 */
        .image-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-detail-content {
            background-color: var(--surface-light);
            border-radius: 15px;
            padding: 1.5rem;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .dark-theme .image-detail-content {
            background-color: var(--surface-dark);
        }
        
        .image-detail-content .close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary-light);
            transition: all 0.3s ease;
        }
        
        .dark-theme .image-detail-content .close {
            color: var(--text-primary-dark);
        }
        
        .image-detail-content .close:hover {
            color: red;
            transform: scale(1.2);
        }
        
        .image-detail-content h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary-light);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 1rem;
        }
        
        .dark-theme .image-detail-content h2 {
            color: var(--text-primary-dark);
            border-bottom-color: var(--border-dark);
        }
        
        .image-comparison {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .comparison-item {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-light);
            background-color: var(--card-bg-light);
        }
        
        .dark-theme .comparison-item {
            border-color: var(--border-dark);
            background-color: var(--card-bg-dark);
        }
        
        .comparison-item h3 {
            padding: 0.8rem;
            margin: 0;
            background-color: var(--primary-light);
            color: white;
            font-size: 1rem;
            text-align: center;
        }
        
        .dark-theme .comparison-item h3 {
            background-color: var(--primary-dark);
        }
        
        .comparison-item img {
            width: 100%;
            height: auto;
            object-fit: contain;
            max-height: 60vh;
            display: block;
        }
        
        .image-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .image-actions a {
            padding: 0.7rem 1.5rem;
            border-radius: 30px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .image-actions .btn-primary {
            background-color: var(--primary-light);
            color: white;
        }
        
        .dark-theme .image-actions .btn-primary {
            background-color: var(--primary-dark);
        }
        
        .image-actions .btn-secondary {
            background-color: var(--secondary-light);
            color: white;
        }
        
        .dark-theme .image-actions .btn-secondary {
            background-color: var(--secondary-dark);
        }
        
        .image-actions a:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .image-comparison {
                flex-direction: column;
            }
            
            .comparison-item {
                width: 100%;
            }
            
            .image-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .image-actions a {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* 添加自定义样式 */
        .record-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        /* 热力图结果样式 */
        .heatmap-result {
            border: 2px solid #17a2b8;
            box-shadow: 0 0 8px rgba(23, 162, 184, 0.5);
        }
        
        .dark-theme .heatmap-result {
            box-shadow: 0 0 8px rgba(23, 162, 184, 0.8);
        }
        
        /* 热力图模式标记 */
        .badge-info {
            background-color: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* 标准模式标记 */
        .badge-standard {
            background-color: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-content">
            <a href="{{ url_for('index') }}" class="nav-logo">
                <i class="fas fa-arrow-left"></i>
                <span>返回首页</span>
            </a>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px;">
        <div class="card fade-in">
            <h1><i class="fas fa-history"></i> 检测记录</h1>
            <p class="subtitle">查看所有图像和视频检测的历史记录</p>

            {% if records %}
                <div class="batch-actions">
                    <div class="select-all-container">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label for="selectAll">全选</label>
                    </div>
                    <button class="batch-delete-btn" id="batchDeleteBtn" onclick="batchDelete()" disabled>
                        <i class="fas fa-trash"></i> 批量删除
                    </button>
                </div>
                
                <div class="records-container">
                    {% for record in records %}
                        <div class="record-card" data-type="{{ record.detection_type }}">
                            <div class="checkbox-container">
                                <input type="checkbox" class="record-checkbox" data-id="{{ record.detection_id }}" onchange="updateBatchDeleteButton()">
                            </div>
                            <div class="record-header">
                                <h2 class="record-title">
                                    {% if record.detection_type == 'image' %}
                                        <i class="fas fa-image"></i> 图像检测
                                    {% elif record.detection_type == 'video' %}
                                        <i class="fas fa-video"></i> 视频检测
                                    {% elif record.detection_type == 'camera' %}
                                        <i class="fas fa-camera"></i> 摄像头检测
                                    {% elif record.detection_type == 'batch_image' %}
                                        <i class="fas fa-images"></i> 批量图像检测
                                    {% endif %}
                                    - {{ record.filename }}
                                </h2>
                                <span class="record-date">{{ record.created_at }}</span>
                            </div>
                            <div class="record-details">
                                <div>
                                    <div class="record-info">
                                        <h3>检测状态</h3>
                                        <p>
                                            {% if record.status == 'processing' %}
                                                <span class="status-badge status-processing">处理中</span>
                                            {% elif record.status == 'completed' %}
                                                <span class="status-badge status-completed">已完成</span>
                                            {% elif record.status == 'error' %}
                                                <span class="status-badge status-error">出错</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="record-info">
                                        <h3>检测类型</h3>
                                        <p>
                                            {% if record.detection_type == 'image' %}
                                                图像检测
                                            {% elif record.detection_type == 'video' %}
                                                视频检测
                                            {% elif record.detection_type == 'camera' %}
                                                摄像头检测
                                            {% elif record.detection_type == 'batch_image' %}
                                                批量图像检测
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="detection-mode">
                                        <h3>检测模式</h3>
                                        <p>
                                            {% if record.metadata and record.metadata.detection_mode == 'heatmap' %}
                                                <span class="badge-info">热力图模式</span>
                                            {% else %}
                                                <span class="badge-standard">标准模式</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                <div>
                                    <div class="record-info">
                                        <h3>文件名</h3>
                                        <p>{{ record.filename }}</p>
                                    </div>
                                    <div class="record-info">
                                        <h3>检测时间</h3>
                                        <p>{{ record.created_at }}</p>
                                    </div>
                                </div>
                            </div>
                            <button class="view-btn" onclick="viewRecordDetails('{{ record.detection_id }}')">
                                <i class="fas fa-eye"></i> 查看详情
                            </button>
                            <button class="delete-btn" onclick="deleteRecord('{{ record.detection_id }}')">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    {% endfor %}
                </div>

                <!-- 分页 -->
                <div class="pagination">
                    {% if page > 1 %}
                        <a href="{{ url_for('detection_records', page=page-1) }}">
                            <i class="fas fa-chevron-left"></i> 上一页
                        </a>
                    {% endif %}
                    
                    {% set start_page = page - 2 if page - 2 > 0 else 1 %}
                    {% set end_page = page + 2 if page + 2 < total_pages else total_pages %}
                    
                    {% for p in range(start_page, end_page + 1) %}
                        {% if p == page %}
                            <span class="current">{{ p }}</span>
                        {% else %}
                            <a href="{{ url_for('detection_records', page=p) }}">{{ p }}</a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page < total_pages %}
                        <a href="{{ url_for('detection_records', page=page+1) }}">
                            下一页 <i class="fas fa-chevron-right"></i>
                        </a>
                    {% endif %}
                </div>
            {% else %}
                <div class="empty-records">
                    <i class="fas fa-search"></i>
                    <h2>暂无检测记录</h2>
                    <p>您还没有进行任何图像或视频检测，请先进行检测。</p>
                    <div>
                        <a href="/image-detection" class="btn btn-primary">
                            <i class="fas fa-image"></i> 图像检测
                        </a>
                        <a href="/video-detection" class="btn btn-primary">
                            <i class="fas fa-video"></i> 视频检测
                        </a>
                        <a href="/camera-detection" class="btn btn-primary">
                            <i class="fas fa-camera"></i> 摄像头检测
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 记录详情模态框 -->
    <div id="recordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">检测记录详情</h2>
            <div class="modal-body" id="modalBody">
                <!-- 记录详情将通过JavaScript动态加载 -->
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 加载中...
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局辅助函数 - 从路径中提取文件名
        function getFilenameFromPath(path) {
            if (!path) return '';
            const parts = path.split(/[\/\\]/);
            return parts[parts.length - 1];
        }
        
        // 全局辅助函数 - 截断长字符串
        function truncateString(str, maxLength) {
            if (!str) return '';
            return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
        }
        
        // 主题切换
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const themeIcon = document.querySelector('.theme-toggle i');
            if (document.body.classList.contains('dark-theme')) {
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'light');
            }
        }

        // 检查保存的主题
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.querySelector('.theme-toggle i').classList.replace('fa-moon', 'fa-sun');
            }
        });

        // 模态框功能
        const modal = document.getElementById('recordModal');
        
        function closeModal() {
            modal.style.display = 'none';
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // 查看记录详情
        async function viewRecordDetails(recordId) {
            try {
                // 显示加载中
                document.getElementById('modalBody').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>正在加载记录详情...</p>
                    </div>
                `;
                
                document.getElementById('recordModal').style.display = 'block';
                
                try {
                    // 发送请求获取记录详情
                    const response = await fetch(`/api/detection-record/${recordId}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误，状态码：${response.status}`);
                    }
                    
                    const record = await response.json();
                    console.log("获取到记录详情:", record);
                    
                    // 格式化创建时间
                    const createdDate = new Date(record.created_at);
                    const formattedDate = createdDate.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    // 检查是否是热力图模式
                    const isHeatmapMode = record.metadata && 
                                          record.metadata.detection_mode === 'heatmap';
                    
                    // 生成详情HTML
                    let detailsHtml = `
                        <div class="modal-detail-section">
                            <h3 class="modal-section-title"><i class="fas fa-info-circle"></i> 基本信息</h3>
                            <div class="record-info-grid">
                                <div class="record-info">
                                    <h3><i class="fas fa-id-card"></i> 检测ID</h3>
                                    <p>${record.detection_id}</p>
                                </div>
                                <div class="record-info">
                                    <h3><i class="fas fa-clock"></i> 创建时间</h3>
                                    <p>${formattedDate}</p>
                                </div>
                                <div class="record-info">
                                    <h3><i class="fas fa-file"></i> 文件名</h3>
                                    <p>${record.filename}</p>
                                </div>
                                <div class="record-info">
                                    <h3><i class="fas fa-tag"></i> 检测类型</h3>
                                    <p>${
                                        record.detection_type === 'image' ? '图像检测' : 
                                        record.detection_type === 'video' ? '视频检测' : 
                                        record.detection_type === 'camera' ? '摄像头检测' : 
                                        record.detection_type === 'batch_image' ? '批量图像检测' : 
                                        record.detection_type === 'batch_image_item' ? '批量图像项' : 
                                        record.detection_type
                                    }</p>
                                </div>
                                <div class="record-info">
                                    <h3><i class="fas fa-tasks"></i> 处理状态</h3>
                                    <div class="status-badge ${
                                        record.status === 'completed' ? 'status-success' : 
                                        record.status === 'processing' ? 'status-processing' : 
                                        record.status === 'error' ? 'status-error' : 
                                        'status-default'
                                    }">
                                        ${
                                            record.status === 'completed' ? '<i class="fas fa-check-circle"></i> 完成' : 
                                            record.status === 'processing' ? '<i class="fas fa-spinner fa-spin"></i> 处理中' : 
                                            record.status === 'error' ? '<i class="fas fa-exclamation-circle"></i> 错误' : 
                                            record.status
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 添加文件路径信息
                    detailsHtml += `
                        <div class="modal-detail-section">
                            <h3 class="modal-section-title"><i class="fas fa-folder-open"></i> 文件路径信息</h3>
                            <div class="record-info">
                                <h3><i class="fas fa-file-upload"></i> 原始文件路径</h3>
                                <p>${record.original_path || '无'}</p>
                            </div>
                            <div class="record-info">
                                <h3><i class="fas fa-file-download"></i> 结果文件路径</h3>
                                <p>${record.result_path || '无'}</p>
                            </div>
                        </div>
                    `;
                    
                    // 添加元数据信息
                    if (record.metadata) {
                        try {
                            let metadataStr;
                            // 处理元数据
                            if (typeof record.metadata === 'object') {
                                metadataStr = JSON.stringify(record.metadata, null, 2);
                            } else if (typeof record.metadata === 'string') {
                                try {
                                    // 尝试解析JSON字符串
                                    const parsedMetadata = JSON.parse(record.metadata);
                                    metadataStr = JSON.stringify(parsedMetadata, null, 2);
                                } catch (e) {
                                    console.warn("元数据JSON解析失败:", e);
                                    metadataStr = record.metadata;
                                }
                            } else {
                                metadataStr = String(record.metadata);
                            }
                            
                            detailsHtml += `
                                <div class="modal-detail-section">
                                    <h3 class="modal-section-title"><i class="fas fa-code"></i> 元数据信息</h3>
                                    <div class="record-info">
                                        <pre style="overflow: auto; max-height: 250px;">${metadataStr}</pre>
                                    </div>
                                </div>
                            `;
                        } catch (e) {
                            console.error('元数据格式化错误:', e);
                            detailsHtml += `
                                <div class="modal-detail-section">
                                    <h3 class="modal-section-title"><i class="fas fa-exclamation-triangle"></i> 元数据格式化错误</h3>
                                    <div class="record-info">
                                        <p>无法显示元数据: ${e.message}</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // 添加结果展示部分
                    if (record.status === 'completed') {
                        detailsHtml += `<div class="modal-detail-section">
                            <h3 class="modal-section-title"><i class="fas fa-poll"></i> 检测结果</h3>`;
                        
                        if (record.detection_type === 'image' && record.filename) {
                            // 准备图像路径
                            let originalPath = `/original/images/${record.filename}`;
                            
                            // 处理结果路径 - 如果是热力图模式，使用_heatmap后缀
                            let resultPath;
                            if (isHeatmapMode) {
                                // 从原始文件名构建热力图文件名
                                const filenameParts = record.filename.split('.');
                                const extension = filenameParts.pop();
                                const baseName = filenameParts.join('.');
                                resultPath = `/processed/images/${baseName}_heatmap.${extension}`;
                                console.log("热力图模式检测结果路径:", resultPath);
                            } else {
                                resultPath = `/processed/images/${record.filename}`;
                            }
                            
                            detailsHtml += `
                                <div class="record-images">
                                    <div class="record-image">
                                        <h4>原始图像</h4>
                                        <img src="${originalPath}" alt="原始图像" onerror="this.onerror=null;this.src='';this.alt='图像加载失败';this.style.display='none';this.parentNode.innerHTML+='<p style=\'text-align:center;padding:1rem;\'>图像加载失败或不存在</p>';">
                                    </div>
                                    <div class="record-image">
                                        <h4>${isHeatmapMode ? '热力图结果' : '检测结果'}</h4>
                                        <img src="${resultPath}" alt="${isHeatmapMode ? '热力图结果' : '检测结果'}" 
                                        class="${isHeatmapMode ? 'heatmap-result' : ''}"
                                        onerror="this.onerror=null;this.src='';this.alt='图像加载失败';this.style.display='none';this.parentNode.innerHTML+='<p style=\'text-align:center;padding:1rem;\'>图像加载失败或不存在</p>';">
                                    </div>
                                </div>
                            `;
                        } else if ((record.detection_type === 'video' || record.detection_type === 'camera') && record.filename) {
                            detailsHtml += `
                                <div style="text-align: center; margin: 2rem 0;">
                                    <a href="/processed/videos/${record.filename}" class="action-btn view-btn" download style="display: inline-flex; padding: 0.8rem 2rem;">
                                        <i class="fas fa-download"></i> 下载检测结果视频
                                    </a>
                                </div>
                            `;
                        } else if (record.detection_type === 'batch_image') {
                            // 检查是否有元数据中的批量处理结果
                            let batchResults = [];
                            
                            try {
                                if (record.metadata) {
                                    if (typeof record.metadata === 'object') {
                                        batchResults = record.metadata.batch_results || record.metadata.results || [];
                                    } else if (typeof record.metadata === 'string') {
                                        const parsedMetadata = JSON.parse(record.metadata);
                                        batchResults = parsedMetadata.batch_results || parsedMetadata.results || [];
                                    }
                                }
                                
                                const timestamp = new Date().getTime(); // 添加时间戳防止缓存
                                
                                detailsHtml += `
                                    <div class="batch-images-container" id="batchImagesContainer">
                                        <h4>批量处理结果 (${batchResults.length}张图片)</h4>
                                `;
                                
                                if (batchResults.length > 0) {
                                    detailsHtml += `<div class="batch-images-grid">`;
                                    
                                    batchResults.forEach((result, index) => {
                                        if (result.status === 'completed') {
                                            const originalFilename = getFilenameFromPath(result.original_path || '');
                                            const resultFilename = getFilenameFromPath(result.result_path || '');
                                            
                                            detailsHtml += `
                                                <div class="batch-image-item ${result.has_defects ? 'has-defects' : 'no-defects'}">
                                                    <div class="batch-image-container">
                                                        <img src="/batch/images/${resultFilename}?t=${timestamp}" alt="${result.filename || `处理结果${index+1}`}" 
                                                            onerror="this.src='/static/images/error-placeholder.jpg';">
                                                        <div class="batch-image-overlay">
                                                            <span class="batch-image-status">${result.has_defects ? '有缺陷' : '无缺陷'}</span>
                                                            <div class="batch-image-actions">
                                                                <a href="#" onclick="showBatchImageDetail('${originalFilename}', '${resultFilename}'); return false;">
                                                                    <i class="fas fa-eye"></i>
                                                                </a>
                                                                <a href="/batch/images/${resultFilename}?download=true" download="${result.filename || `检测结果${index+1}.jpg`}">
                                                                    <i class="fas fa-download"></i>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="batch-image-name">${truncateString(result.filename || `处理结果${index+1}`, 20)}</div>
                                                </div>
                                            `;
                                        }
                                    });
                                    
                                    detailsHtml += `</div>`;
                                } else {
                                    detailsHtml += `<div class="alert alert-info">没有可用的批量处理结果或处理尚未完成。</div>`;
                                }
                                
                                detailsHtml += `</div>`;
                            } catch (e) {
                                console.error('渲染批量处理结果出错:', e);
                                detailsHtml += `
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        加载批量处理结果时出错: ${e.message}
                                    </div>
                                `;
                            }
                        }
                        
                        detailsHtml += `</div>`;
                    }
                    
                    // 更新模态框内容
                    document.getElementById('modalTitle').innerHTML = `
                        ${record.detection_type === 'image' ? '<i class="fas fa-image"></i>' : 
                          record.detection_type === 'video' ? '<i class="fas fa-video"></i>' : 
                          record.detection_type === 'camera' ? '<i class="fas fa-camera"></i>' : 
                          record.detection_type === 'batch_image' ? '<i class="fas fa-images"></i>' : 
                          '<i class="fas fa-question-circle"></i>'} 
                          检测记录详情 - ${record.filename || '未知'}
                    `;
                    document.getElementById('modalBody').innerHTML = detailsHtml;
                    
                } catch (error) {
                    document.getElementById('modalBody').innerHTML = `
                        <div class="error">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>获取记录详情失败: ${error.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('modalBody').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>获取记录详情失败: ${error.message}</p>
                    </div>
                `;
            }
        }

        // 删除记录
        async function deleteRecord(recordId) {
            // 显示确认模态框
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal confirm-modal';
            confirmModal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeConfirmModal()">&times;</span>
                    <h2>确认删除</h2>
                    <p>您确定要删除这个检测记录吗？</p>
                    <div class="btn-group">
                        <button class="btn-cancel" onclick="closeConfirmModal()">取消</button>
                        <button class="btn-delete" onclick="confirmDelete('${recordId}')">删除</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
            confirmModal.style.display = 'block';
        }

        function closeConfirmModal() {
            const confirmModal = document.querySelector('.confirm-modal');
            if (confirmModal) {
                confirmModal.style.display = 'none';
                confirmModal.remove();
            }
        }

        async function confirmDelete(recordId) {
            try {
                // 发送删除请求
                const response = await fetch(`/api/detection-record/${recordId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error('删除记录失败');
                }
                
                // 删除成功后刷新页面
                location.reload();
            } catch (error) {
                alert(`删除记录失败: ${error.message}`);
                closeConfirmModal();
            }
        }
        
        // 批量删除相关函数
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const recordCheckboxes = document.querySelectorAll('.record-checkbox');
            
            recordCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBatchDeleteButton();
        }
        
        function updateBatchDeleteButton() {
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');
            
            batchDeleteBtn.disabled = selectedCheckboxes.length === 0;
        }
        
        function batchDelete() {
            const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                return;
            }
            
            const recordIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.id);
            
            // 显示确认模态框
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal confirm-modal';
            confirmModal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeConfirmModal()">&times;</span>
                    <h2>确认批量删除</h2>
                    <p>您确定要删除选中的 ${recordIds.length} 条检测记录吗？</p>
                    <div class="btn-group">
                        <button class="btn-cancel" onclick="closeConfirmModal()">取消</button>
                        <button class="btn-delete" onclick="confirmBatchDelete()">删除</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
            confirmModal.style.display = 'block';
        }
        
        async function confirmBatchDelete() {
            try {
                const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');
                const recordIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.id);
                
                // 发送批量删除请求
                const response = await fetch('/api/detection-records/batch-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ record_ids: recordIds })
                });
                
                if (!response.ok) {
                    throw new Error('批量删除记录失败');
                }
                
                const result = await response.json();
                
                // 删除成功后刷新页面
                location.reload();
            } catch (error) {
                alert(`批量删除记录失败: ${error.message}`);
                closeConfirmModal();
            }
        }

        function showBatchImageDetail(originalPath, resultPath) {
            try {
                const originalFilename = getFilenameFromPath(originalPath);
                const resultFilename = getFilenameFromPath(resultPath);
                
                // 生成时间戳防止缓存
                const timestamp = new Date().getTime();
                
                console.log(`显示图像详情: 原图=${originalFilename}, 结果=${resultFilename}`);
                
                // 移除可能已存在的图像详情模态框
                const existingModal = document.querySelector('.image-detail-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 创建模态框
                const detailModal = document.createElement('div');
                detailModal.className = 'image-detail-modal';
                detailModal.innerHTML = `
                    <div class="image-detail-content">
                        <span class="close" onclick="document.querySelector('.image-detail-modal').remove()">&times;</span>
                        <h2>图像检测对比</h2>
                        <div class="image-comparison">
                            <div class="comparison-item">
                                <h3>原始图像</h3>
                                <img src="/original/images/${originalFilename}?t=${timestamp}" alt="原始图像" 
                                     onerror="this.onerror=null;this.src='/static/images/error-placeholder.jpg';this.style.padding='2rem';this.style.background='#f8f9fa';">
                            </div>
                            <div class="comparison-item">
                                <h3>检测结果</h3>
                                <img src="/batch/images/${resultFilename}?t=${timestamp}" alt="检测结果" 
                                     onerror="this.onerror=null;this.src='';this.alt='图像加载失败';this.style.display='none';this.parentNode.innerHTML+='<p style=\'text-align:center;padding:1rem;\'>图像加载失败或不存在</p>';">
                            </div>
                        </div>
                        <div class="image-actions">
                            <a href="/original/images/${originalFilename}?download=true" class="btn btn-secondary" download="原始图像.jpg">
                                <i class="fas fa-download"></i> 下载原图
                            </a>
                            <a href="/batch/images/${resultFilename}?download=true" class="btn btn-primary" download="检测结果.jpg">
                                <i class="fas fa-download"></i> 下载结果
                            </a>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(detailModal);
                
                // 触发动画
                setTimeout(() => {
                    detailModal.style.opacity = '1';
                }, 10);
                
                // 添加ESC键关闭功能
                function closeOnEsc(e) {
                    if (e.key === 'Escape') {
                        document.querySelector('.image-detail-modal')?.remove();
                        document.removeEventListener('keydown', closeOnEsc);
                    }
                }
                
                document.addEventListener('keydown', closeOnEsc);
                
                // 点击模态框背景关闭
                detailModal.addEventListener('click', function(e) {
                    if (e.target === detailModal) {
                        detailModal.remove();
                    }
                });
            } catch (error) {
                console.error("显示图像详情失败:", error);
                alert("无法显示图像详情: " + error.message);
            }
        }

        // 在DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 加载检测记录
            loadDetectionRecords();
            
            // 设置刷新事件监听器
            document.getElementById('refresh-records').addEventListener('click', function() {
                loadDetectionRecords();
            });
            
            // 设置批量删除事件监听器
            document.getElementById('delete-selected').addEventListener('click', function() {
                deleteSelectedRecords();
            });
            
            // 设置全选/取消全选事件监听器
            document.getElementById('select-all').addEventListener('change', function() {
                toggleSelectAll(this.checked);
            });
            
            // 设置页面切换事件
            document.querySelectorAll('.pagination-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.dataset.page) || 1;
                    loadPage(page);
                });
            });
            
            // 设置图像查看器
            setupImageViewer();
            
            // 处理所有热力图记录
            processHeatmapRecords();
        });
        
        // 处理所有热力图记录
        function processHeatmapRecords() {
            setTimeout(() => {
                console.log("处理热力图记录");
                const heatmapModeRecords = document.querySelectorAll('.detection-mode .badge-info');
                heatmapModeRecords.forEach(badge => {
                    if (badge.textContent.includes('热力图')) {
                        const recordItem = badge.closest('.record-item');
                        if (recordItem) {
                            const resultImage = recordItem.querySelector('.result-thumbnail');
                            if (resultImage) {
                                let imgSrc = resultImage.getAttribute('src');
                                if (imgSrc && !imgSrc.includes('_heatmap')) {
                                    const urlParts = imgSrc.split('/');
                                    const filename = urlParts[urlParts.length - 1];
                                    const filenameBase = filename.split('.')[0];
                                    const heatmapFilename = `${filenameBase}_heatmap.jpg`;
                                    urlParts[urlParts.length - 1] = heatmapFilename;
                                    const heatmapUrl = urlParts.join('/');
                                    resultImage.src = heatmapUrl;
                                    resultImage.setAttribute('data-src', heatmapUrl);
                                    console.log(`热力图记录: 更新图片 ${imgSrc} -> ${heatmapUrl}`);
                                    resultImage.classList.add('heatmap-result');
                                }
                            }
                        }
                    }
                });
            }, 1000);
        }
    </script>
</body>
</html> 